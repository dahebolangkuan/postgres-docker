# PostgreSQL Docker 镜像变体说明文档

本文档详细说明了本项目中的三个 PostgreSQL Docker 镜像变体（lite, lite2, lite3），以及它们的构建、验证方法和适用场景。

## 1. 镜像概览

| 镜像变体 | 基础大小 | 优化大小 | 目标场景 | 核心特点 |
| :--- | :--- | :--- | :--- | :--- |
| **postgres-lite** | >800MB | N/A | 全功能集成/开发 | 包含 TimescaleDB, pg_audit, pg_parquet 等重型插件。 |
| **postgres-lite2** | ~503MB | N/A | 通用生产环境 | 移除重型插件，保留 AI/搜索/分区核心能力。标准分层构建，调试方便。 |
| **postgres-lite3** | ~508MB | **~362MB** | 边缘计算/极简环境 | **深度系统优化**。扁平化(Flattened)，移除 JIT (LLVM)，保留多语言，体积最小。 |

---

## 2. 详细说明与构建指南

### 2.1 `postgres-lite` (全功能版)

**特点**:
*   集成了最全的插件集合，包括时间序列数据库 (**TimescaleDB**)、审计 (**pgaudit**)、列式存储 (**pg_parquet**) 等。
*   适合需要最大化数据库功能的开发和测试环境。
*   体积较大，启动稍慢。

**构建命令**:
```bash
docker build -t postgres-lite -f Dockerfile.lite .
```

**验证命令**:
```powershell
.\verify_extensions.ps1
```

---

### 2.2 `postgres-lite2` (轻量版)

**特点**:
*   在 `lite` 基础上移除了体积巨大或依赖复杂的插件：`timescaledb`, `pgaudit`, `pg_parquet`。
*   保留了核心的 AI 和分析插件：`pgvector` (向量搜索), `pg_cron` (定时任务), `jsquery` (JSON查询), `pg_partman` (分区管理), `age` (图数据库) 等。
*   使用标准 Docker 多层构建，保留了系统完整的调试符号和工具链，适合标准的生产部署。

**构建命令**:
```bash
docker build -t postgres-lite2 -f Dockerfile.lite2 .
```

**验证命令**:
```powershell
.\verify_extensions_lite2.ps1
```

---

### 2.3 `postgres-lite3` (超轻量优化版)

**特点**:
*   **极致体积优化**:
    *   **扁平化处理 (Flattening)**: 通过 `Export/Import` 技术合并所有 Docker 层，物理移除被删除的文件（核心技术点）。
    *   **移除 JIT**: 卸载了 LLVM 依赖（节省 ~120MB），禁用了 JIT 编译（对简单查询无影响，复杂 OLAP 查询性能可能有损）。
    *   **符号剥离**: 使用 `strip` 移除了二进制文件的调试符号。
    *   **多语言支持**: 相比纯极简版，**恢复保留了多语言 (Locale) 支持**，支持中文排序和本地化错误信息。
*   **适用性**: 适合对镜像传输速度、磁盘占用敏感的场景（如边缘设备、快速扩容节点）。

**构建命令 (推荐)**:
使用专用脚本进行构建和扁平化处理：
```powershell
# 生成镜像名为 postgres-lite-opt-i18n
.\shrink_image.ps1 -ImageName "postgres-lite-opt-i18n"
```
*如果直接运行 `docker build -f Dockerfile.lite3`，得到的镜像大小约为 500MB，无法享受到体积缩减红利。*

**验证命令**:
```powershell
# 验证脚本可以通过参数指定镜像名
.\verify_extensions_lite3.ps1 -ImageName "postgres-lite-opt-i18n"
```

### 2.4 在树莓派 (Raspberry Pi/ARM64) 上的使用

**lite3 非常适合在树莓派等边缘设备上运行**，原因如下：
1.  **极低的内存占用**: 移除了 LLVM JIT 编译器，避免了复杂查询时的高额内存消耗和 CPU 编译开销，非常契合 ARM 环境。
2.  **极小的存储占用**: ~360MB 的镜像体积对 SD 卡非常友好。

**如何为树莓派构建**:
由于树莓派使用 ARM 架构，而 PC 通常是 AMD64 架构，直接拷贝 PC 上构建的镜像无法运行。您需要进行**交叉编译**。
我已在 `shrink_image.ps1` 中增加了对交叉编译的支持。

前提条件：
*   安装 Docker Desktop 并启用 WSL2 后端（通常默认支持 `buildx`）。

构建命令：
```powershell
# 使用 -Platform 参数指定目标架构
.\shrink_image.ps1 -ImageName "postgres-lite-arm64" -Platform "linux/arm64"
```
构建完成后，导出或推送到 Docker Hub 即可在树莓派上拉取运行。

## 3. 插件支持列表对比

| 插件 | 功能 | lite | lite2 | lite3 |
| :--- | :--- | :---: | :---: | :---: |
| **pgvector** | 向量相似度搜索 (AI) | ✅ | ✅ | ✅ |
| **pg_cron** | 数据库定时任务 | ✅ | ✅ | ✅ |
| **jsquery** | 高级 JSON 查询 | ✅ | ✅ | ✅ |
| **pg_partman** | 自动分区管理 | ✅ | ✅ | ✅ |
| **pg_hint_plan** | SQL 执行计划干预 | ✅ | ✅ | ✅ |
| **apache_age** | 图数据库能力 | ✅ | ✅ | ✅ |
| **timescaledb** | 时序数据库 | ✅ | ❌ | ❌ |
| **pgaudit** | 细粒度审计 | ✅ | ❌ | ❌ |
| **pg_parquet** | Parquet 文件读写 | ✅ | ❌ | ❌ |
| **JIT / LLVM** | 查询即时编译加速 | ✅ | ✅ | ❌ |

## 4. 常见问题

1.  **为什么 `lite3` 构建出来还是 500MB？**
    *   Docker 的文件删除 (`RUN rm ...`) 只是在顶层隐藏了文件，并没有真正释放底层镜像占用的空间。必须使用 `docker export` 导出再导入（Flattening），或者使用 `docker build --squash`（实验性功能）才能真正减小体积。请务必使用 `shrink_image.ps1` 脚本构建。

2.  **`lite3` 缺少 JIT 会有什么影响？**
    *   对于简单的增删改查（OLTP）几乎没影响，甚至启动可能更快。但对于涉及数百万行数据的复杂聚合分析查询（OLAP），没有 JIT 加速可能会变慢。

3.  **如何恢复中文支持？**
    *   目前的 `lite3` (v2) 已经修改了策略，不再删除 `/usr/share/locale`，因此已默认支持中文。
